<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wordle + Wallet (Sepolia auto-switch)</title>
<style>
:root{
  --bg:#121213; --card:#0f1720; --muted:#9aa4b2; --white:#e6eef6;
  --green:#2ea44f; --yellow:#b59f3b; --tile:#2b2f36;
}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--white);display:flex;flex-direction:column;align-items:center;min-height:100vh;}
.header{width:100%;max-width:720px;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;box-sizing:border-box;}
.title{font-weight:800;letter-spacing:.12em}
.header-actions{display:flex;gap:10px;align-items:center;position:relative}
.btn{background:var(--card);color:var(--white);border:1px solid rgba(255,255,255,.04);padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.green{background:var(--green);color:#fff;border:0}
.badge{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
.container{width:100%;max-width:560px;padding:18px;box-sizing:border-box}
.card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03);color:var(--muted)}
#game-board{display:grid;grid-template-rows:repeat(6,1fr);gap:8px;width:330px;height:390px;margin:14px auto}
.row{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.tile{border:2px solid rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:2.2rem;height:100%;text-transform:uppercase;background:transparent;color:var(--white)}
.tile[data-state="wrong"]{background:var(--tile);border-color:var(--tile);color:#fff}
.tile[data-state="wrong-location"]{background:var(--yellow);border-color:var(--yellow);color:#111}
.tile[data-state="correct"]{background:var(--green);border-color:var(--green);color:#fff}
.keyboard-row{display:flex;justify-content:center;gap:6px;margin-top:8px}
.key{min-width:36px;height:48px;border-radius:8px;background:#2b3440;border:0;color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 8px}
.key.large{min-width:88px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
.dialog{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03);max-width:420px;text-align:center}
.dropdown{position:absolute;right:16px;top:54px;background:var(--card);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.04);display:none;z-index:60}
.small{font-size:.9rem;color:var(--muted)}
.network-warn{background:#3b2b2b;color:#ffd3a3;padding:6px 10px;border-radius:8px;font-weight:700}
</style>
</head>
<body>

<header class="header">
  <div class="title">WORDLE CLONE</div>
  <div class="header-actions">
    <button id="reset-btn" class="btn">üîÅ Reset</button>
    <button id="theme-btn" class="btn">üåô</button>

    <div id="network-badge" class="badge" title="Network status">Chain: unknown</div>
    <div id="wallet-badge" class="badge">Not connected</div>

    <button id="connect-btn" class="btn green">Connect Wallet</button>

    <div id="wallet-dropdown" class="dropdown" aria-hidden="true">
      <div style="font-weight:700;margin-bottom:6px">Choose Wallet</div>
      <button id="connect-metamask" class="btn" style="width:100%;text-align:left">MetaMask</button>
      <button id="connect-okx" class="btn" style="width:100%;text-align:left">OKX Wallet</button>
      <button id="connect-injected" class="btn" style="width:100%;text-align:left">Injected (Other)</button>
      <div class="small" style="margin-top:6px">If not detected, open extension first then try Injected.</div>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <div style="margin-bottom:12px" class="small">
      Connect your wallet (MetaMask/OKX). After connecting, game will try to switch/add Sepolia automatically when you submit.
    </div>

    <div id="game-board"></div>
    <div id="keyboard"></div>
  </section>
</main>

<!-- Modal -->
<div id="game-modal" class="modal" role="dialog" aria-modal="true">
  <div class="dialog">
    <h2 id="modal-title">Congratulations!</h2>
    <div id="modal-word" style="font-weight:800;font-size:24px;color:var(--green);margin:8px 0">CLOUD</div>
    <div id="modal-sub" class="small">You guessed it in 4 guesses</div>
    <div id="modal-proof" style="margin-top:10px;font-weight:700"></div>
    <div style="margin-top:12px">
      <a id="modal-explorer" href="#" target="_blank" style="display:none;color:var(--muted)">View tx on explorer</a>
    </div>
    <div style="margin-top:14px">
      <button id="submit-btn" class="btn green" style="display:none">Submit Score to Blockchain</button>
      <button id="close-btn" class="btn" style="margin-left:8px">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const CONTRACT_ADDRESS = "0xC5eed354DeAeCddbF17445518A305F7Ced43Fd7e";
const CONTRACT_ABI = ["function submitWordleScore(uint256 guesses)"];
const TARGET = {
  chainId_decimal: 11155111,
  chainId_hex: "0xaa36a7",
  chainName: "Sepolia test network",
  nativeCurrency: { name: "SepoliaETH", symbol: "SepoliaETH", decimals: 18 },
  rpcUrls: ["https://rpc.sepolia.org"],
  blockExplorerUrls: ["https://sepolia.etherscan.io"]
};

/* ---------- GAME ---------- */
const WORDS = ["CLOUD","GHOST","TABLE","APPLE","HOUSE","PLANE","TRAIN","BRICK","FRAME","LIGHT"];
let SECRET = pick();
const ROWS = 6, LEN = 5;
let row=0,col=0,isOver=false;
let guesses = Array(ROWS).fill(null).map(()=>Array(LEN).fill(""));

/* DOM */
const board = document.getElementById('game-board');
const keyboard = document.getElementById('keyboard');
const connectBtn = document.getElementById('connect-btn');
const walletBadge = document.getElementById('wallet-badge');
const networkBadge = document.getElementById('network-badge');
const dropdown = document.getElementById('wallet-dropdown');
const connectMeta = document.getElementById('connect-metamask');
const connectOkx = document.getElementById('connect-okx');
const connectInjected = document.getElementById('connect-injected');
const submitBtn = document.getElementById('submit-btn');
const modal = document.getElementById('game-modal');
const modalProof = document.getElementById('modal-proof');
const modalExplorer = document.getElementById('modal-explorer');
const closeBtn = document.getElementById('close-btn');

let provider=null, signer=null, addr=null, providerName=null;

/* ---------- Helpers ---------- */
function pick(){ return WORDS[Math.floor(Math.random()*WORDS.length)]; }
function short(a){ return a? a.slice(0,6)+'...'+a.slice(-4):''; }
function setWallet(text){ walletBadge.textContent = text; }
function setNetwork(text){ networkBadge.textContent = text; }

/* ---------- Init UI ---------- */
function initBoard(){
  board.innerHTML = '';
  for(let r=0;r<ROWS;r++){
    const rowEl = document.createElement('div'); rowEl.className='row';
    for(let c=0;c<LEN;c++){
      const t = document.createElement('div'); t.className='tile'; t.id=`tile-${r}-${c}`; t.dataset.state='empty';
      rowEl.appendChild(t);
    }
    board.appendChild(rowEl);
  }
}
function initKeyboard(){
  keyboard.innerHTML = '';
  const layout = ["q w e r t y u i o p","a s d f g h j k l","enter z x c v b n m backspace"];
  layout.forEach(r=>{
    const rowEl = document.createElement('div'); rowEl.className='keyboard-row';
    r.split(' ').forEach(k=>{
      const b = document.createElement('button'); b.className='key'; b.id=`key-${k}`; b.textContent = (k==='backspace')?'‚å´': (k==='enter'?'ENTER':k.toUpperCase());
      if(k==='enter' || k==='backspace') b.classList.add('large');
      b.dataset.state=''; b.disabled=false; b.style.cursor='';
      b.addEventListener('click', ()=> handleKey(k));
      rowEl.appendChild(b);
    });
    keyboard.appendChild(rowEl);
  });
}

/* ---------- Input ---------- */
function handleKey(k){
  if(isOver) return;
  if(k==='enter') submit();
  else if(k==='backspace') del();
  else if(k.length===1 && /[a-z]/i.test(k)) add(k);
}
function add(ch){
  if(col>=LEN) return;
  const c = ch.toUpperCase();
  guesses[row][col]=c;
  const tile = document.getElementById(`tile-${row}-${col}`);
  tile.textContent = c; tile.dataset.state='tbd';
  tile.classList.add('bounce'); tile.addEventListener('animationend', ()=> tile.classList.remove('bounce'), {once:true});
  col++;
}
function del(){
  if(col===0) return;
  col--; guesses[row][col]='';
  const tile = document.getElementById(`tile-${row}-${col}`);
  tile.textContent=''; tile.dataset.state='empty';
}
async function submit(){
  if(col!==LEN){ const t=document.getElementById(`tile-${row}-0`); if(t){ t.classList.add('bounce'); t.addEventListener('animationend', ()=> t.classList.remove('bounce'), {once:true}); } return; }
  isOver=true;
  const guess = guesses[row].join('').toUpperCase();
  const freq={}; for(const ch of SECRET) freq[ch]=(freq[ch]||0)+1;
  const states=Array(LEN).fill('wrong');
  for(let i=0;i<LEN;i++){ if(guess[i]===SECRET[i]){ states[i]='correct'; freq[guess[i]]--; } }
  for(let i=0;i<LEN;i++){ if(states[i]!=='correct'){ const ch=guess[i]; if(SECRET.includes(ch) && freq[ch]>0){ states[i]='wrong-location'; freq[ch]--; } } }
  const ps=[];
  for(let i=0;i<LEN;i++){
    const tile=document.getElementById(`tile-${row}-${i}`); const st=states[i];
    ps.push(new Promise(resolve=>{ setTimeout(()=>{ tile.classList.add('flip'); setTimeout(()=> tile.dataset.state = st, 140); tile.addEventListener('animationend', ()=>{ tile.classList.remove('flip'); resolve(); }, {once:true}); }, i*110); }));
  }
  await Promise.all(ps);
  // update keys
  for(let i=0;i<LEN;i++){
    const letter = guess[i]; const key = document.getElementById(`key-${letter.toLowerCase()}`); if(!key) continue;
    const st = states[i]; const cur = key.dataset.state || '';
    if(st==='correct') key.dataset.state='correct';
    else if(st==='wrong-location' && cur!=='correct') key.dataset.state='wrong-location';
    else if(st==='wrong' && cur!=='correct' && cur!=='wrong-location') key.dataset.state='wrong';
    key.disabled=false; key.style.cursor='';
  }
  if(guess===SECRET){ showModal(true, row+1); return; }
  if(row===ROWS-1){ showModal(false, row+1); return; }
  row++; col=0; isOver=false;
}

/* ---------- Modal ---------- */
function showModal(win,count){
  modalProof.textContent=''; modalExplorer.style.display='none'; modalExplorer.removeAttribute('href');
  if(win){
    document.getElementById('modal-word').textContent = SECRET;
    document.getElementById('modal-sub').textContent = `You guessed it in ${count} guesses`;
    modalProof.textContent='Generating proof...';
    // simulate
    setTimeout(()=>{ modalProof.textContent='‚úÖ Verified ‚Äî you can submit (optional)'; submitBtn.style.display='inline-flex'; }, 1000);
    submitBtn.onclick = async ()=> {
      if(!signer || !provider){ modalProof.textContent='Please connect wallet first.'; return; }
      // check network and send
      modalProof.textContent='Checking network (Sepolia)...';
      const raw = provider.provider || window.ethereum;
      const ok = await ensureSepolia(raw, modalProof);
      if(!ok) return;
      // send
      modalProof.textContent='Sending transaction ‚Äî approve in wallet...';
      try{
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const tx = await contract.submitWordleScore(count);
        modalProof.textContent='Transaction sent ‚Äî waiting confirmation...';
        await tx.wait();
        modalProof.textContent='Success ‚Äî score submitted!';
        modalExplorer.href = `https://sepolia.etherscan.io/tx/${tx.hash}`; modalExplorer.style.display='inline-block';
        submitBtn.disabled=true;
      }catch(err){
        console.error('tx error', err);
        modalProof.textContent = 'Transaction failed. See console for details.';
        // show detailed message for common cases
        if(err && err.message) {
          const m = document.createElement('div'); m.style.marginTop='8px'; m.style.fontSize='0.9rem'; m.style.color='#f3b'; m.textContent = 'Error: ' + (err.message || err);
          modalProof.appendChild(m);
        }
      }
    };
  } else {
    document.getElementById('modal-word').textContent = SECRET;
    document.getElementById('modal-sub').textContent = 'Game over ‚Äî try again';
    modalProof.textContent = '';
    submitBtn.style.display='none';
  }
  modal.style.display='flex';
}
closeBtn.addEventListener('click', ()=> modal.style.display='none');

/* ---------- Wallet connect ---------- */
connectBtn.addEventListener('click', (e)=>{ e.stopPropagation(); dropdownToggle(); });
document.addEventListener('click', ()=>{ if(dropdown.style.display==='block') dropdown.style.display='none' });

connectMeta.addEventListener('click', ()=> connect('metamask'));
connectOkx.addEventListener('click', ()=> connect('okx'));
connectInjected.addEventListener('click', ()=> connect('injected'));

async function connect(kind){
  dropdown.style.display='none';
  try{
    if(kind==='metamask'){
      if(!window.ethereum || !window.ethereum.isMetaMask){ alert('MetaMask not detected'); return; }
      await window.ethereum.request({ method:'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      addr = await signer.getAddress();
      providerName = 'MetaMask';
    } else if(kind==='okx'){
      const okxRaw = window.okxwallet || (window.ethereum && window.ethereum.isOkxWallet?window.ethereum:null);
      const raw = okxRaw || window.ethereum;
      if(!raw){ alert('OKX not detected'); return; }
      await raw.request({ method:'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(raw);
      signer = provider.getSigner();
      addr = await signer.getAddress();
      providerName = 'OKX';
    } else {
      if(!window.ethereum){ alert('No injected provider'); return; }
      await window.ethereum.request({ method:'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      addr = await signer.getAddress();
      providerName = (window.ethereum.isMetaMask?'MetaMask':(window.ethereum.isOkxWallet?'OKX':'Injected'));
    }
    setWallet(providerName + ': ' + short(addr));
    // update chain info immediately
    const rawProv = provider.provider;
    try { const cid = await rawProv.request({ method:'eth_chainId' }); const dec = (typeof cid==='string' && cid.startsWith('0x'))?parseInt(cid,16):cid; setNetwork('Chain: ' + dec); } catch(e){ setNetwork('Chain: ?'); }
    // listen
    if(rawProv && rawProv.on){
      rawProv.on('accountsChanged', (accs)=>{ if(!accs || accs.length===0) disconnect(); else { addr=accs[0]; setWallet(providerName+': '+short(addr)); } });
      rawProv.on('chainChanged', (cid)=>{ const dec = (typeof cid==='string' && cid.startsWith('0x'))?parseInt(cid,16):cid; setNetwork('Chain: '+dec); });
    }
  }catch(e){
    console.error('connect error', e);
    alert('Connection failed: ' + (e && e.message ? e.message : e));
  }
}

function disconnect(){ provider=null; signer=null; addr=null; providerName=null; setWallet('Not connected'); setNetwork('Chain: -'); }

/* ---------- Ensure Sepolia (switch/add) ---------- */
async function ensureSepolia(rawProv, statusEl){
  if(!rawProv || !rawProv.request){ if(statusEl) statusEl.textContent='Wallet provider missing'; return false; }
  try{
    const chainIdHex = await rawProv.request({ method:'eth_chainId' });
    const cur = (typeof chainIdHex==='string' && chainIdHex.startsWith('0x'))?parseInt(chainIdHex,16):chainIdHex;
    setNetwork('Chain: '+cur);
    if(cur === TARGET.chainId_decimal) return true;
    if(statusEl) statusEl.textContent = 'Requesting network switch to Sepolia...';
    try{
      await rawProv.request({ method:'wallet_switchEthereumChain', params:[{ chainId: TARGET.chainId_hex }]});
      if(statusEl) statusEl.textContent='Switched to Sepolia';
      return true;
    }catch(switchErr){
      console.warn('switchErr', switchErr);
      // 4902 = chain not added
      if(switchErr && (switchErr.code === 4902 || (switchErr.message && switchErr.message.includes('4902')))){
        try{
          await rawProv.request({ method:'wallet_addEthereumChain', params: [{
            chainId: TARGET.chainId_hex, chainName: TARGET.chainName, nativeCurrency: TARGET.nativeCurrency,
            rpcUrls: TARGET.rpcUrls, blockExplorerUrls: TARGET.blockExplorerUrls
          }]});
          // then switch
          await rawProv.request({ method:'wallet_switchEthereumChain', params:[{ chainId: TARGET.chainId_hex }]});
          if(statusEl) statusEl.textContent='Added & switched to Sepolia';
          return true;
        }catch(addErr){
          console.error('addErr', addErr);
          if(statusEl) statusEl.textContent='Could not add Sepolia: '+ (addErr && addErr.message ? addErr.message : addErr);
          return false;
        }
      } else {
        if(statusEl) statusEl.textContent='Please switch wallet network to Sepolia';
        return false;
      }
    }
  }catch(e){
    console.error('ensureSepolia error', e);
    if(statusEl) statusEl.textContent = 'Network check failed: ' + (e && e.message ? e.message : e);
    return false;
  }
}

/* ---------- Utilities ---------- */
function dropdownToggle(){ dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block'; }

/* ---------- Boot ---------- */
initBoard(); initKeyboard();
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleKey('enter'); else if(e.key==='Backspace') handleKey('backspace'); else if(e.key.length===1 && /[a-z]/i.test(e.key)) handleKey(e.key.toLowerCase()); });
document.getElementById('reset-btn').addEventListener('click', ()=> { if(confirm('Reset game?')) { SECRET=pick(); row=0;col=0;isOver=false;guesses=Array(ROWS).fill(null).map(()=>Array(LEN).fill('')); initBoard(); initKeyboard(); } });
document.getElementById('theme-btn').addEventListener('click', ()=> document.body.classList.toggle('light'));

</script>
</body>
</html>
